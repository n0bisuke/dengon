function MilkCocoa(t,e){if(this.host=t,this.option=e||{},this.file_path=this.option.file_path||"/var/lib/mlkcca",this.storage=new Storage(this.file_path),this.app_id=this.option.app_id||this.host.match(/([a-z0-9]+)\.mlkcca\.com/)[1],!this.app_id)throw new Error("app_id must be specified");this.option.clientId||(this.option.clientId="js"+this.app_id.substr(this.app_id.length-5)+clientid(16)),this.option.app_id=this.app_id,this.listeners=new Listeners,this.idGenerator=new IdGenerator,this.connect()}function querystring(t){var e=[];for(var o in t)e.push(o+"="+encodeURIComponent(t[o]));return e.join("&")}var IdGenerator=require("./idgenerator"),Listeners=require("./listeners"),Transporter=require("./transporter"),DataStore=require("./datastore"),myconsole=require("./logger"),Storage=require("./storage"),DataElement=require("./dataelement"),clientid=require("./clientid");MilkCocoa.prototype.connect=function(t){function e(e){o.start_ts=(new Date).getTime(),o.idGenerator.init(e),o.server_ts=Math.floor(e/1e3),t&&t()}var o=this,r=null,n=this.storage.get("mlkcca_sid");n&&(r=n.sid),this.transporter=new Transporter(this.host,this.option,r,e),this.transporter.onMessage(function(t){if(t.content.hasOwnProperty("params"))if("string"==typeof t.content.params)t.content.params=JSON.parse(t.content.params);else if("object"!=typeof t.content.params)throw new Error("unknown params");switch(t.event){case"push":o.listeners.fire("push",t.path,{id:t.content.id,path:t.path,value:t.content.params,timestamp:t.content.ts});break;case"set":o.listeners.fire("set",t.path,{id:t.content.id,path:t.path,value:t.content.params});break;case"remove":o.listeners.fire("remove",t.path,{id:t.content.id,path:t.path});break;case"send":o.listeners.fire("send",t.path,{path:t.path,value:t.content.params});break;case"success":console.log("success",t)}}),this.server_ts=(new Date).getTime(),this.start_ts=(new Date).getTime()},MilkCocoa.prototype.onConnected=function(t){this.transporter.onConnected(t)},MilkCocoa.prototype.onClosed=function(t){this.transporter.onClosed(t)},MilkCocoa.prototype.onError=function(t){this.transporter.onError(t)},MilkCocoa.prototype.get_time=function(){var t=(new Date).getTime()-this.start_ts;return Math.floor(this.server_ts+t)},MilkCocoa.connectWithAuth=function(t,e,o){var r=o||{};r.token=e;var n=new MilkCocoa(t,r);return n.authWithToken(e,function(t){}),n},MilkCocoa.connectWithApiKey=function(t,e,o,r){var n=r||{};n.apikey=e,n.apisecret=o;var i=new MilkCocoa(t,n);return i},MilkCocoa.prototype.disconnect=function(t){this.transporter.disconnect(t)},MilkCocoa.prototype.reconnect=function(t){var e=this;this.transporter.disconnect(function(){e.connect(function(){e.listeners.get_subscribes().forEach(function(t){e.transporter.on(t.path,t.event)}),t&&t()})})},MilkCocoa.prototype.dataStore=function(t){if("string"!=typeof t)throw new Error("path must be string");return new DataStore(this,t)},MilkCocoa.prototype.authWithToken=function(t,e){if("string"!=typeof t)throw new Error("token must be string");var o=this;this.transporter.auth_call("loginwithtoken",{token:t},function(t,r){return t?void e(t):r.err?void e(r.err):(o.storage.set("mlkcca_sid",{sid:r.sid}),void o.reconnect(function(){o.user(e)}))})},MilkCocoa.prototype.authAsAdmin=function(t,e){if("string"!=typeof t)throw new Error("token must be string");var o=this;this.transporter.auth_call("loginasadmin",{token:t},function(t,r){return r.err?void e(r.err):(o.storage.set("mlkcca_sid",{sid:r.sid}),void o.reconnect(function(){o.user(e)}))})},MilkCocoa.prototype.user=function(t){var e=this.storage.get("mlkcca_sid"),o={};e&&(o.mlkccasid=e.sid),this.transporter.auth_call("me",o,function(e,o){return o.err?void t(o.err):"notloggedin"==o.content.condition?void t(null,null):void t(o.err,o.content.account)})},MilkCocoa.prototype.getCurrentUser=function(t){this.user(t)},MilkCocoa.prototype.logout=function(t){var e=this,o=this.storage.get("mlkcca_sid"),r={};o&&(r.mlkccasid=o.sid),this.transporter.auth_call("logout",r,function(o){return o&&t?void t(o):void e.reconnect(t)})},"browser"!==process.title?module.exports=MilkCocoa:window.MilkCocoa=MilkCocoa;