function Transporter(t,e,r,o){function s(t){c._is_connected=!0,c.flush(),myconsole.log("transporter:onopen",t),o&&o(t),c._onConnected&&c._onConnected()}function n(t){c._is_connected=!1,myconsole.log("transporter:onclose",t),c._onClosed&&c._onClosed()}function i(t){myconsole.log("transporter:onerror",t.message),c._onError&&c._onError(t)}function p(t,e){var r={};if(t==c.app_id+"/$sys/error"){var o=e.readUInt16BE(0),s=e.readUInt16BE(2);return void c.recvError(s,o)}try{r=JSON.parse(c.decode(e))}catch(n){r=JSON.parse(e)}var i=t.indexOf("/"),p=t.lastIndexOf("/"),a=t.substr(i+1,p-i-1),h=t.substr(p+1),u={path:a,event:h,content:r};c._onMessage(u)}var c=this;this.sid=r,this.queue=[],this.error_callbacks={},this.comp_callbacks={},this.request_id=1,this.app_id=e.app_id,this.host=t,this.port=e.port||443,this.http_port=e.http_port||443,this.useSSL=!0,this.qos=0;var a="s"+r||"dammy";e.token&&(a="j"+e.token),e.apikey&&e.apisecret&&(a="k"+e.apikey+":"+e.apisecret),e.hasOwnProperty("qos")&&(this.qos=e.qos),e.hasOwnProperty("useSSL")&&(this.useSSL=e.useSSL);var h=(this.useSSL?"wss://":"ws://")+t+":"+this.port+"/websocket";"browser"!==process.title?(this.port=this.useSSL?8883:1883,h=(this.useSSL?"mqtts://":"mqtt://")+t+":"+this.port):useragent.isAndroidStandardBrowser()&&(h=(this.useSSL?"sockjss://":"sockjs://")+t+":"+this.port+"/sockjs"),this.client=mows.connect(h,{username:a,clientId:e.clientId,password:e.app_id,protocolId:"MQIsdp",protocolVersion:3,reconnectPeriod:7e3,clean:!1}),this.client.onConnectionLost=n,this.client.onMessageArrived=p,this.client.on("connect",s),this.client.on("close",n),this.client.on("error",i),this.client.on("message",p),this._is_connected=!1}var myconsole=require("./logger"),useragent=require("./ua"),ajax=require("./ajax"),mows=require("mqtt"),DataElement=require("./dataelement");module.exports=Transporter,Transporter.prototype.encode=function(t){return t},Transporter.decode=function(t){return decodeURIComponent(t)},Transporter.prototype.decode=function(t){return Transporter.decode(t)},Transporter.prototype.onMessage=function(t){this._onMessage=t},Transporter.prototype.onConnected=function(t){this._onConnected=t},Transporter.prototype.onClosed=function(t){this._onClosed=t},Transporter.prototype.onError=function(t){this._onError=t},Transporter.prototype.auth_call=function(t,e,r){e.cmd=t,e.appid=this.app_id,ajax.request("POST",this.useSSL,this.host,this.http_port,"/auth",e,r)},Transporter.prototype.call=function(t,e,r){e.api=t,e.appid=this.app_id,this.sid&&(e.mlkccasid=this.sid),ajax.request("GET",this.useSSL,this.host,this.http_port,"/api",e,r)},Transporter.prototype.on=function(t,e){this.send({type:"s",topic:this.create_topic(t,e)})},Transporter.prototype.off=function(t,e){this.send({type:"u",topic:this.create_topic(t,e)})},Transporter.prototype.send_operation_request=function(t,e,r,o,s){this.request_id++,this.request_id>12287&&(this.request_id=1),r.r=this.request_id,this.error_callbacks[this.request_id]=s,this.comp_callbacks[this.request_id]=o,this.send({type:"p",topic:this.create_topic(t,e),msg:JSON.stringify(r),request_id:this.request_id})},Transporter.prototype.create_topic=function(t,e){return this.app_id+"/"+t+"/"+e},Transporter.prototype.send=function(t){var e=this;e._is_connected?e.send_op(t):e.queue.push(t)},Transporter.prototype.flush=function(){this.send_next()},Transporter.prototype.send_next=function(){var t=this;if(t._is_connected){var e=t.queue.shift();e&&(t.send_op(e),t.send_next())}},Transporter.prototype.send_op=function(t){var e=this;switch(t.type){case"p":var r=e.encode(t.msg);e.client.publish(t.topic,r,{qos:e.qos,retain:!1},function(r,o){e.recvComp(t.request_id,null,DataElement.format(JSON.parse(t.msg)))});break;case"s":e.client.subscribe(t.topic,{qos:3==e.qos?0:e.qos});break;case"u":e.client.unsubscribe(t.topic)}},Transporter.prototype.recvError=function(t,e){function r(t){switch(t){case 3:return"permission denied";default:return"unknown error"}}var o=r(e);this.error_callbacks[t]?(this.error_callbacks[t](o),delete this.error_callbacks[t]):this._onError&&this._onError(o)},Transporter.prototype.recvComp=function(t,e,r){this.comp_callbacks[t]&&this.comp_callbacks[t](e,r),delete this.comp_callbacks[t]},Transporter.prototype.disconnect=function(t){this.client.end(t)};